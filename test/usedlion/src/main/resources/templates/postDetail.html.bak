<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>게시글 상세</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #f8fafc;
        font-family: "Segoe UI", sans-serif;
      }
      .header {
        background: linear-gradient(to right, #4f46e5, #3b82f6);
        color: white;
        padding: 1rem;
      }
      .container {
        max-width: 800px;
        margin: 2rem auto;
      }
      .card {
        border-radius: 1rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        padding: 2rem;
        background-color: white;
        margin-bottom: 1.5rem;
      }
      .post-title {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 1rem;
      }
      .post-meta {
        color: #6b7280;
        font-size: 14px;
        margin-bottom: 1rem;
      }
      .post-content {
        white-space: pre-wrap;
        font-size: 16px;
        margin-top: 1rem;
      }
      .reply-container {
        background-color: #fff;
        padding: 1.5rem;
        border-radius: 1rem;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      }
      #modalBackdrop {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
      }
      .my-modal {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        width: 400px;
        max-width: 90%;
        box-sizing: border-box;
      }
    </style>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const contentElement = document.getElementById("postContent");
        let content = contentElement.innerText;
        let formattedContent = "";
        const lineLength = 50;
        for (let i = 0; i < content.length; i += lineLength) {
          formattedContent += content.substring(i, i + lineLength) + "<br>";
        }
        contentElement.innerHTML = formattedContent;
      });

      function openReportModal(id) {
        document.getElementById("reportModal-" + id).style.display = "block";
        document.getElementById("modalBackdrop").style.display = "block";
      }
      function closeModal(modalId) {
        document.getElementById(modalId).style.display = "none";
        document.getElementById("modalBackdrop").style.display = "none";
      }
    </script>
  </head>

  <body>
    <div class="header d-flex justify-content-between align-items-center px-4">
      <h4 class="m-0">📄 글 상세보기</h4>
      <a href="/dashboard" class="btn btn-light">목록</a>
    </div>

    <div id="modalBackdrop"></div>

    <div class="container">
      <div class="card">
        <div class="post-title" th:text="${post.title}">제목</div>

        <div class="post-meta">
          조회수: <span th:text="${post.view}">0</span><br />
          작성자:
          <a
            th:href="@{/user/{userId}(userId=${post.userId})}"
            th:text="${post.username}"
            >작성자</a
          >
          <br />
          작성일:
          <span
            th:text="${#temporals.format(post.created_at, 'yyyy-MM-dd HH:mm')}"
            >날짜</span
          >
        </div>

        <div th:if="${currentUsername != post.username}">
          <div class="d-flex gap-2 mb-3">
            <button
              type="button"
              class="btn btn-outline-danger"
              onclick="openReportModal('post')"
            >
              🚨 신고하기
            </button>
            <form
              th:action="${isLiked} ? @{/post/unlike/{postId}(postId=${post.postId})} : @{/post/like/{postId}(postId=${post.postId})}"
              method="post"
            >
              <button type="submit" class="btn btn-outline-primary">
                <span th:text="${isLiked ? '좋아요 취소' : '👍 좋아요'}"
                  >좋아요</span
                >
              </button>
            </form>
          </div>
        </div>

        <div
          th:if="${currentUsername == post.username}"
          class="mb-3 d-flex gap-2"
        >
          <a
            th:href="@{/post/edit/{postId}(postId=${post.postId})}"
            class="btn btn-warning"
            >✏️ 수정</a
          >
          <form
            th:action="@{/post/delete/{id}(id=${post.postId})}"
            method="post"
            onsubmit="return confirm('정말 삭제하시겠습니까?')"
          >
            <input type="hidden" name="_method" value="delete" />
            <button type="submit" class="btn btn-danger">🗑️ 삭제</button>
          </form>
        </div>

        <!-- 게시글 신고 모달 -->
        <div id="reportModal-post" class="my-modal">
          <form
            th:action="@{/report/{postId}/{userId}(postId=${post.postId}, userId=${post.userId})}"
            method="post"
          >
            <h5 class="mb-3">🚨 신고 사유 입력</h5>
            <textarea
              name="reason"
              rows="4"
              class="form-control mb-3"
              placeholder="신고 내용을 입력해주세요."
              required
            ></textarea>
            <div class="d-flex justify-content-end gap-2">
              <button type="submit" class="btn btn-danger">제출</button>
              <button
                type="button"
                class="btn btn-secondary"
                onclick="closeModal('reportModal-post')"
              >
                취소
              </button>
            </div>
          </form>
        </div>

        <div class="post-content">
          <p th:text="${post.content}" id="postContent"></p>
        </div>

        <div th:if="${imageList != null}" class="mt-3">
          <div th:each="img : ${imageList}" class="mb-2">
            <img
              th:src="'data:image/jpeg;base64,' + ${img}"
              class="img-fluid rounded"
              style="max-width: 100%; height: auto"
              alt="게시글 이미지"
            />
          </div>
        </div>
      </div>

      <div class="reply-container mt-4">
        <h5 class="mb-3">💬 댓글</h5>
        <ul>
          <th:block th:each="node : ${replyTree}">
            <div
              th:replace="~{replyNode :: reply(${node}, 0, ${post.postId},${post.userId})}"
            ></div>
          </th:block>
        </ul>

        <form
          th:action="@{/reply/{postId}(postId=${post.postId})}"
          method="POST"
          class="mt-3"
        >
          <input
            type="text"
            name="content"
            class="form-control mb-2"
            placeholder="댓글을 입력하세요"
            required
          />
          <input type="hidden" name="postId" th:value="${post.postId}" />
          <button type="submit" class="btn btn-primary">댓글 작성</button>
        </form>
      </div>
    </div>
  </body>
</html>
